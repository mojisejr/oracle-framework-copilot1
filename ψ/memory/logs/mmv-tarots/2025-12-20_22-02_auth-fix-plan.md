---
project: mmv-tarots
issue: #none
tags: []
date: 2025-12-20
agent: oracle-keeper
---

# Snapshot: Plan to Fix Better Auth Line Login Issues

**Time**: 2025-12-20 22:02
**Context**: Analyzing and planning fixes for the "Provider did not return email" error and other potential Better Auth issues based on historical project data (Issues #48, #187, #62, #70).

## Insight

1.  **Email Requirement**: Better Auth requires an email field for user creation. Line Login often returns null for email.
    - **Fix**: Implement `mapProfileToUser` in `lib/auth.ts` to generate a placeholder email: `email: profile.email || \`${profile.sub}@line.placeholder\``.
2.  **Scope Management**: Explicitly defining scopes prevents unexpected behavior.
    - **Fix**: Set `scopes: ["profile", "openid"]` in the Line provider configuration.
3.  **Schema Compatibility**: Verified that the current `User` model uses `cuid()`, which avoids UUID format conflicts with Better Auth tokens (Lesson from Issue #62).
4.  **Vercel Compatibility**: By sticking to Line Login only and disabling `emailAndPassword`, we avoid native dependency issues (Argon2) on Vercel (Lesson from Issue #187).
5.  **Configuration Safety**: `BETTER_AUTH_SECRET` must be present to avoid library initialization failure.

## Apply When

- Encountering "Provider did not return email" error during Line OAuth.
- Setting up social login for a project that doesn't require traditional email/password.
- Ensuring database schema compatibility with Better Auth.

## Tags

`auth-plan` `better-auth` `line-login` `email-fix` `mmv-tarots`
