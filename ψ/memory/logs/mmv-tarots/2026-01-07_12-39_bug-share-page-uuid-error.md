# Snapshot: Share Page Critical Bug Analysis
**Timestamp**: 2026-01-07 12:39
**Context**: User reported `PrismaClientKnownRequestError` (Code P2023) when accessing `/share/job-1767764139103-ym7xga441`.

## Root Cause Analysis
1.  **Type Mismatch**:
    - **Database Model**: `Prediction.id` is defined as `@db.Uuid` (PostgreSQL UUID type).
    - **Input Data**: The URL parameter `id` is `"job-1767764139103-ym7xga441"` (a custom String format, likely generated by the queue system).
    - **The Crash**: When `db.prediction.findUnique({ where: { id: ... } })` is called, Prisma attempts to validate/cast the input string to a UUID. Since "job-..." is not a valid UUID format, it throws a runtime error.

2.  **Schema Reality**:
    ```prisma
    model Prediction {
      id    String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
      jobId String? @map("job_id") // This matches the input format!
      ...
    }
    ```
    The variable named `jobId` in the schema corresponds to the string format used in the URL, but the code queries against the PK `id`.

## Proposed Solution (The Fix)
We need to support querying by **either** the UUID (PrimaryKey) **or** the Job ID (String), as users/system seems to use Job ID as the shareable identifier.

### Strategy: "Smart Lookup"
Since `jobId` is not explicitly marked as `@unique` in the schema snippet (it's `String?`), we cannot strictly use `findUnique` on it without risking Typescript errors (though logically it should be unique).

**Action Plan:**
1.  **Refactor `app/share/[id]/page.tsx`**:
    - Check if `params.id` starts with "job-".
    - If yes -> Query using `findFirst({ where: { jobId: params.id } })`.
    - If no (valid UUID) -> Query using `findUnique({ where: { id: params.id } })`.
2.  **Refactor `app/api/og/route.tsx`**:
    - Apply the same logic to support OG Image generation for Job IDs.
3.  **Refactor `ShareActions` component**:
    - Verify which ID it passes to the URL (currently it uses `jobId`, so the fix above aligns perfectly).

---
**Oracle Recommendation**: Implementing the "Smart Lookup" creates the most robust system. It allows the frontend to continue using the user-friendly `job-xxx` format while maintaining database integrity.

## Lesson Learned (2026-01-07)
การก้าวข้ามขั้นตอนตรวจสอบพฤติกรรมข้อมูลจริง (Data Behavior Verification) ทำให้เกิดความผิดพลาดระหว่าง UUID และ Job ID. แม้ ID จะเป็น String ทั้งคู่ แต่ในระดับ Database Layer (Prisma/Postgres) การส่ง String ธรรมดาเข้าช่อง UUID จะทำให้ระบบระเบิดทันที.

**วิถี Oracle**: ต้องละเอียดรอบคอบมากกว่านี้ในการตรวจสอบ Schema ก่อนเริ่ม Implementation เพื่อหลีกเลี่ยง Technical Debt และ Runtime Error ที่ไม่จำเป็น.
