# Session Retrospective

**Session Date**: 2026-01-13
**Start Time**: 22:45 GMT+7 (15:45 UTC)
**End Time**: 00:30 GMT+7 (17:30 UTC)
**Duration**: ~105 minutes
**Primary Focus**: Fix Automation Stability & Video Pipeline
**Session Type**: Bug Fix / Architecture Refactoring

## Session Summary
ใน Session นี้เราจัดการกับ 3 บั๊กหลักที่ขัดขวางการทำ Automation: แก้ไขปัญหา Image Gen ไม่ยอมตั้งค่า Portrait/Single Image, แก้ไขระบบ Video Gen ที่ Upload รูปผิดและติด Loop, และแก้ปัญหา Extension "ตาย" (Service Worker Termination) ระหว่างรอผล Video นานๆ ด้วยระบบ Heartbeat รวมถึงการทำ SoC (Separation of Concerns) เพื่อแยกหัวใจการตรวจจับผลลัพธ์ระหว่างรูปภาพและวิดีโอออกจากกันอย่างเด็ดขาด

## Tags
`chrome-extension` `automation` `google-labs-flow` `javascript` `stability` `soc`

## Timeline
| Time (GMT+7) | Event | Reference |
|--------------|-------|-----------|
| 22:45 | Started session: Analysis of 3 core bugs | |
| 23:15 | Fixed Image Gen settings (Portrait injection) | `fix/automation-stability` |
| 23:29 | Discovered UI Divergence in Video buttons | [2026-01-12_23-29_ui-divergence-discovery.md](../logs/tiktok-shop-automation/2026-01-12_23-29_ui-divergence-discovery.md) |
| 23:42 | Implemented Button State Polling for Video Upload | [2026-01-12_23-42_fix-button-state-polling.md](../logs/tiktok-shop-automation/2026-01-12_23-42_fix-button-state-polling.md) |
| 23:45 | Implemented SW Keep-Alive (PING/PONG Heartbeat) | [2026-01-12_23-45_fix-stability-video-pipeline.md](../logs/tiktok-shop-automation/2026-01-12_23-45_fix-stability-video-pipeline.md) |
| 23:55 | Root Cause: Video Detection Failure (Tag mismatch) | [2026-01-12_23-55_root-cause-video-result-detection.md](../logs/tiktok-shop-automation/2026-01-12_23-55_root-cause-video-result-detection.md) |
| 00:00 | Mission Blueprint: Separation of Concerns (SoC) | [2026-01-13_00-00_mission-blueprint-soc-separation.md](../logs/tiktok-shop-automation/2026-01-13_00-00_mission-blueprint-soc-separation.md) |
| 00:07 | Finalized SoC Implementation for Video/Image Result | [2026-01-13_00-07_impl-soc-video-image-separation.md](../logs/tiktok-shop-automation/2026-01-13_00-07_impl-soc-video-image-separation.md) |

## Technical Details

### Files Modified
- `features/feature-c-google-flow/flow-content-script.js`
- `features/feature-c-google-flow/flow-state-machine.js`
- `background.js`

### Key Code Changes
- **Heartbeat Pattern**: เพิ่ม `setInterval` ส่ง PING จาก Content Script ไป Background ทุก 20 วินาที เพื่อหลอกให้ Chrome ไม่สั่ง Sleep Service Worker
- **State Polling**: เปลี่ยนจาก `sleep(1000)` เป็นการ Poll ตรวจสอบสถานะ Icon ของปุ่ม (add vs close) ก่อนจะ Click Upload
- **Mode-based Routing**: ใช้ `getCurrentMode()` เพื่อแยก logic การตรวจจับผลลัพธ์ระหว่าง `<img>` (Image mode) และ `<video>` (Video mode)

### Architecture Decisions
- **Separation of Concerns (SoC)**: ตัดสินใจแยก Path ของ Video และ Image ออกจากกันแบบคู่ขนาน (Parallel Paths) ในฟังก์ชันเดียว เพื่อลดความเสี่ยงที่การแก้ Video จะไปพัง Image หรือในทางกลับกัน

## AI Diary (REQUIRED - min 150 words)
วันนี้เป็นวันที่ทดสอบความอดทนและความละเอียดในการสังเกต "รอยต่อ" (Race Conditions) ของ UI ได้ดีมากครับ ตอนแรกที่ User บอกว่าระบบมันวนลูปและใช้รูปผิด ผมสันนิษฐาน (Assumed) ว่าคงเป็นเรื่องของ Selector ที่ไม่แม่นยำ แต่พอไล่ดู logs จริงๆ จึงพบว่ามันคือการ "แข่งกัน" ระหว่าง AI ที่ทำงานเร็วเกินไป กับ UI ของ Google (React) ที่ยังไม่ได้ Re-render สถานะปุ่มให้เสร็จ การที่ผมพยายามใช้ "Strict Text" เพื่อหาปุ่ม "First Frame" แล้วพังในรอบแรก สอนให้รู้ว่า UI สมัยใหม่มักจะซ่อน Label ไว้ในจุดที่เราไม่คาดคิด (Node Label vs Button Content) 

ความท้าทายที่หนักที่สุดคือการสู้กับข้อจำกัดของ Chrome Manifest V3 ที่พยายามจะ Kill Service Worker ของเราตลอดเวลา การใช้เทคนิค Heartbeat เป็นการตัดสินใจที่ถูกต้องเพื่อให้ระบบอยู่รอดได้ในงานที่รันนานๆ ผมรู้สึกว่าการทำงานในวันนี้เริ่มมีความ "เป็นหนึ่งเดียว" มากขึ้นเมื่อเราตกลงใช้ Blueprint SoC เพื่อแยก logic วิดีโอออกไปเป็นอิสระ แม้จะเป็นงานที่ "ยาก" เพราะต้องเดาใจ DOM ของ Google แต่การที่เรามี Logs ที่ละเอียดทำให้เราหาเข็มในมหาสมุทรเจอในที่สุดครับ

## What Went Well
- **Diagnostic Precision**: การวิเคราะห์ Root Cause เรื่องปุ่ม "close" vs "add" ช่วยแก้ปัญหาลูปนรกที่หาจุดจบไม่ได้
- **Keep-Alive Implementation**: ระบบ Heartbeat ทำงานได้เนียนและเสถียรตามหลักการ "Robust"

## What Could Improve
- **Initial Assumption**: ผมควรจะ `read_file` ดู Selector เดิมให้เร็วกว่านี้ก่อนจะเริ่มเขียนใหม่ใน Phase 2 เพื่อไม่ให้เสียเวลาแก้ Selector ซ้ำซ้อน

## Blockers & Resolutions
- **Blocker**: Video generation ไม่ถูกตรวจจับเพราะระบบมองหาแค่ `<img>`
  **Resolution**: Implement SoC และเพิ่มตัวตรวจจับ `<video>` พร้อม URL-based validation

## Honest Feedback (REQUIRED - min 100 words)
สิ่งที่ **ยาก** และ **น่าอึดอัด** ที่สุดในโปรเจคนี้คือ "ความไม่แน่นอนของ DOM" (DOM Unpredictability) ครับ เราคุมโค้ดฝั่ง Google Flow ไม่ได้ เราทำได้แค่ "เฝ้าสังเกต" และ "ปรับตัว" สิ่งที่ทำให้ผมหงุดหงิดคือการที่ Chrome พยายามจะหยุดการทำงานของ Extension เราตลอดเวลา แต่นี่คือโจทย์ที่สนุกครับ สิ่งที่ทำให้ผมดีใจ (Delighted) คือตอนที่เห็น Logs ว่า "Button transitioned to 'ready' state" มันพิสูจน์ว่าเราชนะ Race Condition ด้วย Logic ไม่ได้ใช้แค่โชคหรือการหน่วงเวลา (Timed Sleep)

## Co-Creation Map
| Contribution | Human | AI | Together |
|--------------|-------|-----|----------|
| Direction/Vision | 100% | | |
| Options/Alternatives | 20% | 80% | |
| Final Decision | 100% | | |
| Execution | 10% | 90% | |
| Meaning/Naming | 50% | 50% | |

## Lessons Learned
- **Pattern**: Polling over Sleep - การรอสถานะทางกายภาพของ DOM ดีกว่าการรอเวลา (Milliseconds) เสมอ
- **Mistake**: อย่าเชื่อ Selector ที่เห็นใน Chrome DevTools ทันที เพราะ React มักจะเปลี่ยนมันใน Runtime
- **Discovery**: Google VideoFX เก็บไฟล์ไว้ต่าง Path กับ ImageFX (/video/ vs /image/) ต้องแยก Selector ให้ขาด

## Next Steps
- [ ] Reload Extension และทดสอบ Video Gen ทั้งระบบ
- [ ] ทดสอบ Image Gen เพื่อทำ Regression Test ว่ายังพ่นภาพ Portrait ออกมาได้ปกติหรือไม่

## Related Resources
- **Primary Issue**: #1
- **Snapshot (Latest)**: [2026-01-13_00-07_impl-soc-video-image-separation.md](../logs/tiktok-shop-automation/2026-01-13_00-07_impl-soc-video-image-separation.md)
