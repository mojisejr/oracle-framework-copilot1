# Session Retrospective: Package & Promotion System Init

**Timestamp**: 2026-01-05 23:42 (GMT+7)
**Issue ID**: #none
**Status**: PAUSED (Bug Found)

## 1. What did we do?
- ออกแบบระบบ Package & Promotion ใหม่แบบ Product-Price Separation
- แก้ไข `schema.prisma` เพื่อรองรับหลายราคา (Regular/Promo) ต่อ 1 Package
- สร้าง API `/api/user/promo-eligibility` เพื่อเช็คสิทธิ์ลูกค้าใหม่
- Refactor API `/api/checkout/stripe` ให้รองรับ `priceId` และตรวจสอบสิทธิ์ Promo
- อัปเดตหน้า UI `app/package/page.tsx` ให้แสดงราคาโปรโมชันสำหรับลูกค้าใหม่
- Seed ข้อมูล Package และ Price เบื้องต้น (Starter, Standard, Premium)

## 2. Current State (CRITICAL)
- **Git Branch**: อยู่ใน branch `feat/package-promotion-system` ในโปรเจกต์ `mmv-tarots`
- **Commit Status**: **ยังไม่ได้ Commit** และ **ยังไม่ได้ Merge** เข้า `staging`
- **Database**: Migration สำเร็จแล้ว ข้อมูลเก่าถูกล้างและ Seed ใหม่แล้ว

## 3. Problems & Blockers
- **BUG**: ทดสอบเติมเงินแล้ว Stripe แจ้งว่าสำเร็จ แต่:
    1. ไม่มี Transaction เพิ่มใน Database (`credit_transactions`)
    2. จำนวน Stars ของ User ไม่เพิ่มขึ้น
- **Hypothesis**: 
    - Webhook อาจจะไม่ทำงาน หรือ Metadata ที่ส่งไปใน Checkout Session ไม่ตรงกับที่ Webhook คาดหวัง
    - อาจเกิดจาก `stripeSessionId` ใน Metadata หรือการ Parse `stars` ใน Webhook
    - ต้องเช็ค Stripe CLI logs หรือ Server logs ในวันพรุ่งนี้

## 4. Next Steps (Tomorrow)
- [ ] Debug Stripe Webhook (`app/api/webhooks/stripe/route.ts`)
- [ ] ตรวจสอบ Metadata ที่ส่งจาก Checkout Session ว่าครบถ้วนไหม
- [ ] เมื่อแก้ Bug ได้แล้ว ให้ Commit และ Merge เข้า `staging`
- [ ] ทดสอบ Flow ทั้งหมดอีกครั้ง (New User vs Existing User)

## 5. Alignment Check
- ระบบมีความ Robust มากขึ้นตามหลัก Product-Price Separation
- ยังคงรักษาความเรียบง่าย (Simple/Robust) ตาม Oracle Coding Standard
