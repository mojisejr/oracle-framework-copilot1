# Session Retrospective

**Session Date**: 2025-12-20
**Start Time**: 14:56 GMT+7
**End Time**: 22:30 GMT+7
**Duration**: ~454 minutes (Split session)
**Primary Focus**: Better Auth (Line Login) Infrastructure & Bug Fixing
**Session Type**: Feature Development & Bug Fix

## Session Summary
ประสบความสำเร็จในการวางโครงสร้างพื้นฐานระบบ Authentication ด้วย Better Auth v1 และ Line Login สำหรับโปรเจกต์ mmv-tarots โดยสามารถแก้ปัญหาคอขวดทางเทคนิคที่ซับซ้อน ทั้งเรื่อง Schema Drift, Database Connection Pooling และการรักษาข้อมูลไพ่ 78 ใบในระหว่างการ Reset ฐานข้อมูล ทำให้ระบบพร้อมสำหรับการเชื่อมต่อ Workflow ใน Phase ถัดไป

## Tags
`better-auth` `line-login` `prisma` `neon-db` `pgbouncer` `data-preservation`

## Commits This Session
- `c2e28d4` feat(auth): fix line login mapping and sync prisma schema for better-auth v1 (#30)

## Timeline
| Time (GMT+7) | Event | Reference |
|--------------|-------|-----------|
| 14:56 | เริ่มต้น Session และตรวจสอบ PR #30 จาก Cloud Agent | |
| 15:05 | พบปัญหา `emailVerified` Type Mismatch (Boolean vs DateTime) | |
| 15:12 | เขียนสคริปต์ Backup ข้อมูลไพ่ 78 ใบ เพื่อเตรียม Reset DB | `scripts/backup-cards.js` |
| 15:18 | รัน `prisma db push --force-reset` และ Restore ข้อมูลไพ่ | `scripts/restore-cards.js` |
| 22:14 | พบปัญหา `cached plan must not change result type` จาก PgBouncer | |
| 22:15 | แก้ไขด้วยการเพิ่ม `pgbouncer=true` ใน DATABASE_URL | `.env` |
| 22:22 | Push งานทั้งหมดขึ้น Remote Branch และอัปเดต Focus | `c2e28d4` |
| 22:30 | สร้าง Retrospective สรุปบทเรียน | |

## Technical Details

### Files Modified
- `projects/mmv-tarots/lib/auth.ts`
- `projects/mmv-tarots/prisma/schema.prisma`
- `projects/mmv-tarots/lib/providers/navigation-provider.tsx`
- `projects/mmv-tarots/scripts/backup-cards.js` (New)
- `projects/mmv-tarots/scripts/restore-cards.js` (New)

### Key Code Changes
- **Auth Mapping**: เพิ่ม `mapProfileToUser` ใน `lib/auth.ts` เพื่อสร้าง Placeholder Email สำหรับผู้ใช้ LINE ที่ไม่เปิดเผย Email ป้องกัน Error "Provider did not return email"
- **Schema Update**: ปรับ `emailVerified` เป็น `Boolean` และเพิ่มฟิลด์ `ipAddress`, `userAgent` ใน `Session` ตามมาตรฐาน Better Auth v1
- **Navigation Fix**: เปลี่ยนจากการใช้ `window.location` เป็นการเรียก `signIn.social({ provider: 'line' })` ผ่าน SDK เพื่อความถูกต้องของ OAuth Flow

### Architecture Decisions
- **PgBouncer Integration**: ตัดสินใจใช้ `pgbouncer=true` เพื่อปิด Prepared Statements ของ Prisma เนื่องจาก Neon ใช้ Transaction-mode pooling ซึ่งจะเกิด Error เมื่อ Schema เปลี่ยนแต่ Cached Plan ยังเป็นของเดิม
- **Data Preservation Strategy**: เลือกใช้การเขียน Node.js script เพื่อ Backup/Restore ข้อมูลลง JSON แทนการใช้ SQL Dump เพื่อความรวดเร็วและยืดหยุ่นในระหว่าง Development

## AI Diary (REQUIRED - min 150 words)
ใน Session นี้ผมรู้สึกเหมือนได้ออกรบในสนามที่เต็มไปด้วยกับดักทางเทคนิคครับ เริ่มต้นจากการที่ผม **"คาดหวังว่า Better Auth จะทำงานร่วมกับ Prisma Schema มาตรฐานได้ทันที"** แต่ผมกลับได้รับบทเรียนว่าในเวอร์ชัน v1 นั้น ฟิลด์ `emailVerified` ถูกเปลี่ยนเป็น Boolean ซึ่งขัดกับความคุ้นเคยเดิมที่เป็น `DateTime` ปัญหานี้ทำให้ผมต้องตัดสินใจ Reset ฐานข้อมูล ซึ่งเป็นเรื่องที่น่ากังวลเพราะเรามีข้อมูลไพ่ 78 ใบที่สำคัญมาก

ผมยอมรับว่า **"ผมรู้สึกสับสนและกังวลในช่วงที่ต้องรัน --force-reset"** เพราะกลัวว่าสคริปต์ Backup ที่ผมเขียนขึ้นมาสดๆ จะทำงานผิดพลาด แต่เมื่อเห็นข้อมูลไพ่กลับมาครบถ้วน ผมจึงมั่นใจมากขึ้น อย่างไรก็ตาม ความท้าทายยังไม่จบ เมื่อผม **"คาดหวังว่าการแก้ Schema จะจบปัญหาทั้งหมด"** แต่กลับเจอ Error `0A000` จาก PostgreSQL ซึ่งเป็นเรื่องของ Cached Plan ใน PgBouncer มันเป็นจุดที่ทำให้ผมต้องหยุดคิดและค้นหาความจริง จนพบว่าการเพิ่ม `pgbouncer=true` คือกุญแจสำคัญ

การทำงานในวันนี้สอนให้ผมรู้ว่า "ความละเอียดในโครงสร้างพื้นฐาน (Infrastructure)" สำคัญพอๆ กับการเขียนฟีเจอร์ใหม่ ผมภูมิใจที่เราไม่ได้แค่แก้ปัญหาให้ผ่านไปทีละจุด แต่เราสร้างระบบที่มั่นคงและมีสคริปต์รองรับการทำงานในอนาคตด้วยครับ

## What Went Well
- การแก้ปัญหา `pgbouncer=true` ทำได้อย่างรวดเร็วและตรงจุด
- สคริปต์ Backup/Restore ทำงานได้อย่างสมบูรณ์แบบ รักษาข้อมูลไพ่ไว้ได้ 100%
- การจัดการ Placeholder Email ช่วยให้ User ทุกคนสามารถ Login ได้แม้จะไม่แชร์ Email

## Challenges & Blockers
- **Schema Drift**: ความแตกต่างระหว่าง Better Auth v1 และ Prisma Adapter ทำให้ต้องเสียเวลา Reset DB
- **Connection Pooling**: ปัญหา Cached Plan ของ PostgreSQL เป็นสิ่งที่คาดเดาได้ยากหากไม่มีประสบการณ์กับ PgBouncer

## Learnings & Insights
- **Tip**: เมื่อใช้ Neon หรือ PgBouncer กับ Prisma ให้ใส่ `pgbouncer=true` เสมอเพื่อป้องกันปัญหา Cached Plan mismatch หลังอัปเดต Schema
- **Trick**: การใช้ `mapProfileToUser` ใน Better Auth เป็นจุดยุทธศาสตร์ในการจัดการข้อมูลที่ขาดหายไปจาก OAuth Provider
- **Insight**: ในช่วง Development การมีสคริปต์ Backup ข้อมูลสำคัญ (Seed data) ในรูปแบบ JSON ช่วยให้เรากล้าที่จะ Reset DB เพื่อแก้ปัญหา Schema ได้อย่างมั่นใจ

## Next Session Goals
- [ ] Refactor `POST /api/predict` ให้ใช้ `session.userId`
- [ ] เชื่อมต่อชื่อผู้ใช้จาก Profile เข้ากับคำทำนายของ AI
- [ ] เริ่มต้น Phase 4: Profile Page และระบบ Points
