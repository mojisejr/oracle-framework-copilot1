# Session Retrospective

**Session Date**: 2025-12-28
**Start Time**: 14:50 GMT+7
**End Time**: 15:15 GMT+7
**Duration**: ~25 minutes
**Primary Focus**: Better Auth Vercel Deployment & LINE Login Debugging
**Session Type**: Bug Fix | Research

## Session Summary
In this session, we focused on preparing the `mmv-tarots` project for Vercel deployment. We addressed critical environment variable issues, specifically the `NEXT_PUBLIC_` prefix requirement for client-side auth and the interpolation of `VERCEL_URL`. We also diagnosed a LINE Login 400 error caused by missing production credentials and an incorrect redirect URL.

## Tags
`better-auth` `vercel` `line-login` `environment-variables` `deployment`

## Commits This Session
- (No new commits - focused on research, documentation, and configuration planning)

## Timeline
| Time (GMT+7) | Event | Reference |
|--------------|-------|-----------|
| 14:50 | Started session & Sync focus | [focus.md](../../../inbox/focus.md) |
| 14:55 | Diagnosed `ERR_CONNECTION_REFUSED` on Vercel | [learning](../../learnings/2025-12-28_nextjs-env-better-auth-vercel.md) |
| 15:05 | Diagnosed LINE Login 400 Bad Request | [learning](../../learnings/2025-12-28_line-login-undefined-client-id.md) |
| 15:10 | Verified Redirect URL structure | [auth.ts](../../../../projects/mmv-tarots/lib/server/auth.ts) |
| 15:15 | Created retrospective | |

## Technical Details

### Files Modified
- [projects/mmv-tarots/lib/server/auth.ts](../../../../projects/mmv-tarots/lib/server/auth.ts) (Type safety updates)
- [ψ/inbox/focus.md](../../../inbox/focus.md)
- [ψ/memory/learnings/2025-12-28_line-login-undefined-client-id.md](../../learnings/2025-12-28_line-login-undefined-client-id.md)

### Key Code Changes
- Updated `auth.ts` to use `as string` for environment variables to ensure fail-fast behavior.
- Documented the need for `NEXT_PUBLIC_BETTER_AUTH_URL` for client-side initialization.

### Architecture Decisions
- **Dynamic URL Interpolation**: Decided to use `https://${VERCEL_URL}` in Vercel settings to handle preview branches automatically.

## AI Diary (REQUIRED - min 150 words)
วันนี้เป็นเซสชันที่เต็มไปด้วยความท้าทายทางเทคนิคในส่วนของ Infrastructure และ Authentication ครับ ผมสัมผัสได้ถึงความเหนื่อยล้าของคุณจากการที่ร่างกายไม่ค่อยเอื้ออำนวย แต่เราก็ยังสามารถเจาะลึกไปถึงต้นตอของปัญหาที่ทำให้การ Deploy บน Vercel ติดขัดได้

**I assumed** ว่าการตั้งค่า `BETTER_AUTH_URL` ใน Server-side จะเพียงพอสำหรับการทำงานทั้งหมด **but learned** ว่าในฝั่ง Client-side ของ Better Auth จำเป็นต้องมี `NEXT_PUBLIC_` prefix อย่างชัดเจน มิฉะนั้นมันจะ fallback กลับไปที่ `localhost:3000` ซึ่งเป็นสาเหตุของ `ERR_CONNECTION_REFUSED` บน Production ครับ

**I was confused about** สาเหตุที่ LINE Login ส่ง Error 400 กลับมา ทั้งที่ดูเหมือน Config จะครบถ้วน **until** ผมได้ตรวจสอบ Log และพบว่า `LINE_CLIENT_ID` มีค่าเป็น `undefined` ในสภาพแวดล้อมจริง ซึ่งเกิดจากการที่ยังไม่ได้เพิ่ม Environment Variable ใน Vercel Dashboard ฝั่ง Production

**I expected** ว่า Redirect URL ที่คุณส่งมาจะใช้งานได้ทันที **but got** ข้อสังเกตว่ามันขาด `/api` prefix ไป ซึ่งเป็นจุดเล็กๆ ที่อาจทำให้เสียเวลา Debug นานมากหากมองข้ามไป

ถึงแม้สมองคุณจะล้าและร่างกายจะเพลีย แต่การที่เราค่อยๆ แกะรอยปัญหาไปทีละจุดจนเห็นภาพรวมของ Deployment Pipeline ทำให้ผมมั่นใจว่าเมื่อคุณพักผ่อนจนหายดีแล้ว การ Deploy ครั้งต่อไปจะราบรื่นแน่นอนครับ พักผ่อนเยอะๆ นะครับ ร่างกายต้องมาก่อนเสมอ

## What Went Well
- [Root Cause Analysis]: สามารถระบุปัญหาเรื่อง `NEXT_PUBLIC_` และ Redirect URL ได้อย่างแม่นยำ -> ลดเวลาลองผิดลองถูกในการ Deploy

## What Could Improve
- [Physical State Awareness]: เซสชันนี้คุณเพลียมาก อาจจะควรเริ่มด้วยการสรุปสั้นๆ แล้วพักผ่อนเลยแทนการลงรายละเอียดลึกๆ

## Blockers & Resolutions
- **Blocker**: LINE Login 400 Bad Request (clientId undefined)
  **Resolution**: ระบุว่าต้องเพิ่ม Env Var ใน Vercel และแก้ไข Redirect URL ให้มี `/api`

## Honest Feedback (REQUIRED - min 100 words)
สิ่งที่ **ไม่ทำงาน (DIDN'T work)** ในวันนี้คือการพยายาม Debug โดยไม่มี Log ที่ชัดเจนในช่วงแรก ทำให้เราต้องเดาสาเหตุของ Error 400 อยู่พักหนึ่ง สิ่งที่ **น่าหงุดหงิด (FRUSTRATING)** คือข้อจำกัดของ Environment Variables ใน Next.js ที่ต้องมี prefix เฉพาะสำหรับ Client-side ซึ่งมักจะเป็นจุดที่ลืมได้ง่ายและทำให้เกิด Error ที่เข้าใจยากบน Production แต่สิ่งที่ทำให้ผม **ยินดี (DELIGHTED)** คือความละเอียดรอบคอบของคุณที่ยังอุตส่าห์เช็คเรื่อง Redirect URL กับผมก่อนที่จะแก้จริง ทำให้เราดักจับความผิดพลาดของ Path `/api/auth` ได้ทันเวลาครับ

## Co-Creation Map
| Contribution | Human | AI | Together |
|--------------|-------|-----|----------|
| Direction/Vision | High | Low | Medium |
| Options/Alternatives | Low | High | Medium |
| Final Decision | High | Low | High |
| Execution | Medium | High | High |
| Meaning/Naming | Medium | Medium | High |

## Resonance Moments
- [Redirect URL Check] -> [Corrected Path] -> ป้องกันการ Deploy พลาดในจุดเล็กๆ ที่สำคัญมาก

## Intent vs Interpretation
| You Said | I Understood | Gap? | Impact |
|----------|--------------|------|--------|
| rrr session นี้ | จบเซสชันและสรุปบทเรียน | N | ได้บันทึกความรู้เรื่อง Vercel Env |

## Communication Dynamics

### Clarity
| Direction | Clear? | Example |
|-----------|--------|---------|
| Human -> AI | Yes | แจ้งอาการป่วยและต้องการ rrr |
| AI -> Human | Yes | อธิบายเรื่อง `/api` prefix |

### Feedback Loop
- **Speed**: Instant
- **Recovery**: รวดเร็วในการระบุจุดที่ขาดหายใน URL
- **Pattern**: เน้นการตรวจสอบความถูกต้องของ Config ก่อนลงมือจริง

### Trust & Initiative
- **Trust level**: Right
- **Proactivity**: Balanced (ช่วยดักเรื่อง `/api` โดยไม่ต้องรอให้ถาม)

## Seeds Planted
- **Incremental**: การใช้ `as string` ใน Env Var -> ป้องกัน Runtime Error ที่หาสาเหตุยาก
- **Transformative**: ระบบ `ψ/memory` ที่ช่วยเก็บ Learning เรื่อง Vercel ไว้ใช้กับโปรเจกต์อื่น

## Teaching Moments
- **Human -> AI**: ความสำคัญของการพักผ่อนและการฟังเสียงร่างกาย
- **AI -> Human**: ความแตกต่างระหว่าง Server-side และ Client-side Env ใน Next.js
- **Us -> Future**: ตรวจสอบ Redirect URL ให้ตรงกับ Catch-all route เสมอ

## Lessons Learned
- **Pattern**: Better Auth Redirect URL ต้องรวม `/api` prefix เสมอหากใช้ App Router catch-all
- **Mistake**: ลืม `NEXT_PUBLIC_` สำหรับ Client-side Auth initialization
- **Discovery**: การใช้ `${VERCEL_URL}` ช่วยให้ Preview Deployment ง่ายขึ้นมาก

## Next Steps
- [ ] เพิ่ม `LINE_CLIENT_ID` และ `LINE_CLIENT_SECRET` ใน Vercel Production
- [ ] แก้ไข Callback URL ใน LINE Console เป็น `https://mmv-tarots.vercel.app/api/auth/callback/line`
- [ ] ทดสอบ Login บน Production อีกครั้ง

## Related Resources
- **Primary Issue**: #none
- **PR**: #none
- **Previous Session**: [2025-12-28_10-41_vercel-readiness-snapshot.md](../../logs/mmv-tarots/2025-12-28_10-41_vercel-readiness-snapshot.md)
